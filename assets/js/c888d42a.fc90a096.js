"use strict";(self.webpackChunkgetstart=self.webpackChunkgetstart||[]).push([[679],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>m});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=a.createContext({}),u=function(e){var t=a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(r),f=n,m=d["".concat(s,".").concat(f)]||d[f]||p[f]||o;return r?a.createElement(m,l(l({ref:t},c),{},{components:r})):a.createElement(m,l({ref:t},c))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,l=new Array(o);l[0]=f;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[d]="string"==typeof e?e:n,l[1]=i;for(var u=2;u<o;u++)l[u]=r[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,r)}f.displayName="MDXCreateElement"},7884:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>u});var a=r(7462),n=(r(7294),r(3905));const o={title:"Cloudflare Tunnel",sidebar_label:"Cloudflared",slug:"cloudflared",tags:["docker swarm","stack"]},l=void 0,i={unversionedId:"stack/cloudflared-stack",id:"stack/cloudflared-stack",title:"Cloudflare Tunnel",description:"Already deployed:",source:"@site/docs-docker-swarm/stack/cloudflared-stack.md",sourceDirName:"stack",slug:"/stack/cloudflared",permalink:"/getstart/docker-swarm/stack/cloudflared",draft:!1,tags:[{label:"docker swarm",permalink:"/getstart/docker-swarm/tags/docker-swarm"},{label:"stack",permalink:"/getstart/docker-swarm/tags/stack"}],version:"current",lastUpdatedBy:"imoize",lastUpdatedAt:1691211684,formattedLastUpdatedAt:"Aug 5, 2023",frontMatter:{title:"Cloudflare Tunnel",sidebar_label:"Cloudflared",slug:"cloudflared",tags:["docker swarm","stack"]},sidebar:"tutorialSidebar",previous:{title:"Authelia",permalink:"/getstart/docker-swarm/stack/authelia"},next:{title:"CrowdSec",permalink:"/getstart/docker-swarm/stack/crowdsec"}},s={},u=[{value:"Tunnel",id:"tunnel",level:3},{value:"How it works",id:"how-it-works",level:3},{value:"Setup",id:"setup",level:2},{value:"Configure Zero Trust",id:"configure-zero-trust",level:3},{value:"Install connector",id:"install-connector",level:4},{value:"Stack",id:"stack",level:3},{value:"Deploy Services",id:"deploy-services",level:3}],c={toc:u},d="wrapper";function p(e){let{components:t,...r}=e;return(0,n.kt)(d,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("admonition",{title:"Prereq",type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"Already deployed:"),(0,n.kt)("p",{parentName:"admonition"},"\u2705 Docker ",(0,n.kt)("a",{parentName:"p",href:"/getstart/docker-swarm/swarm-mode"},"swarm cluster")," with persistent ",(0,n.kt)("a",{parentName:"p",href:"/getstart/docker-swarm/shared-storage"},"shared storage")),(0,n.kt)("p",{parentName:"admonition"},"\u2705 ",(0,n.kt)("a",{parentName:"p",href:"/getstart/docker-swarm/stack/traefik"},"Traefik"))),(0,n.kt)("p",null,"If your network is behind Carrier-grade NAT (CGN), you can use cloudflare tunnel for expose your services without opening port 80 and 443."),(0,n.kt)("h3",{id:"tunnel"},"Tunnel"),(0,n.kt)("p",null,"Cloudflare Tunnel provides you with a secure way to connect your resources to Cloudflare without a publicly routable IP address. With Tunnel, you do not send traffic to an external IP \u2014 instead, a lightweight daemon in your infrastructure (cloudflared) creates outbound-only connections to Cloudflare\u2019s global network. Cloudflare Tunnel can connect HTTP web servers, SSH servers, remote desktops, and other protocols safely to Cloudflare. This way, your origins can serve traffic through Cloudflare without being vulnerable to attacks that bypass Cloudflare."),(0,n.kt)("h3",{id:"how-it-works"},"How it works"),(0,n.kt)("p",null,"Cloudflared establishes outbound connections (tunnels) between your resources and Cloudflare\u2019s global network. Tunnels are persistent objects that route traffic to DNS records. Within the same tunnel, you can run as many cloudflared processes (connectors) as needed. These processes will establish connections to Cloudflare and send traffic to the nearest Cloudflare data center."),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://developers.cloudflare.com/assets/handshake_hufad68abf6107ffc2ef859ebe1b42b6e2_299675_1768x1102_resize_q75_box-3f75968f.jpg",alt:null})),(0,n.kt)("h2",{id:"setup"},"Setup"),(0,n.kt)("h3",{id:"configure-zero-trust"},"Configure Zero Trust"),(0,n.kt)("p",null,"Login to your cloudflare ",(0,n.kt)("a",{parentName:"p",href:"https://dash.cloudflare.com/"},"dashboard")," go to ",(0,n.kt)("a",{parentName:"p",href:"https://one.dash.cloudflare.com/"},"Zero Trust")," -> Access -> Tunnels then ",(0,n.kt)("inlineCode",{parentName:"p"},"Create a tunnel")),(0,n.kt)("h4",{id:"install-connector"},"Install connector"),(0,n.kt)("p",null,"Since we use Traefik Proxy and configure DNS Record in clodflare dashboard setup Public Hostname is slightly different."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Select ",(0,n.kt)("inlineCode",{parentName:"li"},"Docker")," and copy docker run command or your TOKEN, after copied hit next.")),(0,n.kt)("p",null,"Create two Public Hostname:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Add first ",(0,n.kt)("inlineCode",{parentName:"li"},"Puclic Hostname")," with the following:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Domain: Choose YOUR DOMAIN"),(0,n.kt)("li",{parentName:"ul"},"Type: HTTPS or HTTP if you use it"),(0,n.kt)("li",{parentName:"ul"},"URL: Your Traefik Services name ",(0,n.kt)("inlineCode",{parentName:"li"},"traefik_proxy")))),(0,n.kt)("li",{parentName:"ul"},"Add second ",(0,n.kt)("inlineCode",{parentName:"li"},"Public Hostname")," with the following:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Subdomain: *"),(0,n.kt)("li",{parentName:"ul"},"Domain: Choose YOUR DOMAIN"),(0,n.kt)("li",{parentName:"ul"},"Type: HTTPS or HTTP if you use it"),(0,n.kt)("li",{parentName:"ul"},"URL: Your Traefik Services name ",(0,n.kt)("inlineCode",{parentName:"li"},"traefik_proxy"))))),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"You may need to disable TLS verify, edit Public Hostname:"),(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},"Additional application settings -> TLS -> No TLS Verify set to Enable"))),(0,n.kt)("h3",{id:"stack"},"Stack"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"sudo micro cloudflare-stack.yaml\n")),(0,n.kt)("p",null,"Put your cloudflare tunnel token to ",(0,n.kt)("inlineCode",{parentName:"p"},"TUNNEL_TOKEN=")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3.9"\n\nservices:\n  tunnel:\n    image: cloudflare/cloudflared:latest\n    command: tunnel run\n    environment:\n      - TUNNEL_TOKEN=YOUR_CLOUDFLARE_TUNNEL_TOKEN\n    networks:\n      - traefik_proxy\n    deploy:\n      mode: global\n      placement:\n        constraints: [node.role == manager]\n\nnetworks:\n  traefik_proxy:\n    external: true\n')),(0,n.kt)("h3",{id:"deploy-services"},"Deploy Services"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"sudo docker stack deploy cloudflare -c cloudflare-stack.yaml\n")),(0,n.kt)("p",null,"That's it now you can access your services with your domain without opening port forward."),(0,n.kt)("p",null,"And you can add DNS Record in cloudflare dashboard with CNAME target to your root domain or ",(0,n.kt)("inlineCode",{parentName:"p"},"@"),"."))}p.isMDXComponent=!0}}]);